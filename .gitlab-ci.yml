stages:
  - build
  - release

variables:
  # Flutter & Android paths (GitLab shared runners usually on Linux)
  ANDROID_SDK_ROOT: "/opt/android-sdk"
  ANDROID_HOME: "/opt/android-sdk"

# Only run pipeline for tags (release-style)
workflow:
  rules:
    - if: '$CI_COMMIT_TAG'   # run only when a tag is pushed

# ---------- Build APK job ----------
build_apk:
  stage: build
  image: cirruslabs/flutter:3.35.6
  script:
    - flutter --version
    - flutter pub get
    - flutter build apk --release
    # apk will be at build/app/outputs/flutter-apk/app-release.apk
    - ls -R build/app/outputs
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
    expire_in: 1 week

# ---------- Release job ----------
create_release:
  stage: release
  image: alpine:latest
  needs:
    - build_apk
  script:
    - apk add --no-cache curl jq

    # Optional: rename APK to include tag name, e.g. app-v1.0.0.apk
    - export APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
    - export APK_NAME="app-${CI_COMMIT_TAG}.apk"
    - cp "$APK_PATH" "$APK_NAME"

    # Create or update GitLab Release with asset link
    - |
      curl --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"Release $CI_COMMIT_TAG\",
          \"tag_name\": \"$CI_COMMIT_TAG\",
          \"description\": \"Automated release for tag $CI_COMMIT_TAG\",
          \"assets\": {
            \"links\": [
              {
                \"name\": \"APK $CI_COMMIT_TAG\",
                \"url\": \"${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/$APK_NAME\"
              }
            ]
          }
        }" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
  dependencies:
    - build_apk
  artifacts:
    paths:
      - app-${CI_COMMIT_TAG}.apk
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'   # also only on tags

